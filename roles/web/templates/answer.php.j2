<?php
header('Content-Type: text/plain');
header('Cache-Control: no-cache, no-store, must-revalidate');

require_once __DIR__ . '/../lib/nodes.php';

// Get client IP for hostname determination
$client_ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';

// Proxmox auto-installer sends POST data with system information
// Parse POST data to extract MAC address
$post_data = file_get_contents('php://input');
$system_info = json_decode($post_data, true);

// Extract MAC address from system info or fallback to GET parameter
$mac = '';
if ($system_info && isset($system_info['network_interfaces'])) {
    foreach ($system_info['network_interfaces'] as $interface) {
        if (isset($interface['mac']) && !empty($interface['mac'])) {
            $mac = strtolower($interface['mac']);
            break; // Use first available MAC address
        }
    }
}

// Fallback to GET parameter if available
if (empty($mac)) {
    $mac = $_GET['mac'] ?? '';
}

// Normalize MAC address format (convert semicolons to colons if needed)
$mac = str_replace(';', ':', $mac);

// Log the request for debugging
error_log("Proxmox answer request - IP: {$client_ip}, MAC: {$mac}, POST data: " . substr($post_data, 0, 500));

$node = get_node_by_mac($mac);
$hostname = $node['hostname'] ?? 'unknown-node'; // Default

// Generate dynamic answer file
$config = <<<TOML
# Proxmox VE 9.0 Auto-Installer Configuration (answer.toml format)
# This file configures the Proxmox VE auto-installer for unattended installation

[global]
keyboard = "en-us"
country = "jp"
fqdn = "{$hostname}.{{ domain }}"
mailto = "{{ mailto | default('admin@' + domain) }}"
timezone = "{{ timezone | default('UTC') }}"
root-password = "{{ root_password }}"

[network]
source = "from-dhcp"
filter = "net.ifnames.mac == '{$mac}'"

[disk-setup]
filesystem = "zfs"
disk_list = ["sda"]
zfs.raid = "raid0"
zfs.compress = "on"
zfs.checksum = "on"
zfs.copies = 1
zfs.hdsize = 32

[post-installation-webhook]
url = "http://{{ server_ip }}/index.php?action=callback&status=DONE&mac={$mac}"

TOML;

echo $config;
?>