<?php
header('Content-Type: text/plain');
header('Cache-Control: no-cache, no-store, must-revalidate');

// Get client IP for hostname determination
$client_ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown';

// Determine hostname based on IP or MAC (if provided)
$mac = $_GET['mac'] ?? '';
$hostname = 'node4'; // Default

// Map IP addresses to hostnames if needed
$ip_to_hostname = [
    '10.10.1.21' => 'node1',
    '10.10.1.22' => 'node2', 
    '10.10.1.23' => 'node3',
    '10.10.1.24' => 'node4'
];

if (isset($ip_to_hostname[$client_ip])) {
    $hostname = $ip_to_hostname[$client_ip];
}

// Generate dynamic answer file
$config = <<<TOML
# Proxmox VE 9.0 Auto-Installer Configuration (answer.toml format)
# This file configures the Proxmox VE auto-installer for unattended installation

[global]
keyboard = "en-us"
country = "jp"
fqdn = "{$hostname}.{{ domain }}"
mailto = "{{ mailto | default('admin@' + domain) }}"
timezone = "{{ timezone | default('UTC') }}"
root-password = "{{ root_password }}"

[network]
source = "from-dhcp"

[disk-setup]
filesystem = "zfs"
disk_list = ["sda"]
zfs.raid = "raid0"
zfs.compress = "on"
zfs.checksum = "on"
zfs.copies = 1
zfs.hdsize = 32

[post-installation-webhook]
url = "http://{{ server_ip }}/index.php?action=callback&status=DONE&mac={$mac}"

TOML;

echo $config;
?>