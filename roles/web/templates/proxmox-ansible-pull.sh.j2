#!/bin/bash
# Proxmox Ansible Pull Script
# This script is called from the post-install script to run Ansible configurations

set -e

PROVISION_SERVER="{{ server_ip }}"
HOSTNAME=$(hostname -s)
LOG_FILE="/var/log/proxmox-ansible-pull.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "Starting Ansible pull for $HOSTNAME"

# Install Ansible if not present
if ! command -v ansible &> /dev/null; then
    log "Installing Ansible..."
    apt-get update
    apt-get install -y ansible python3-proxmoxer python3-requests
fi

# Create temporary directory for playbook
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

# Download the playbook
log "Downloading Proxmox post-install playbook..."
curl -s "http://$PROVISION_SERVER/playbooks/proxmox-post-install.yml" -o proxmox-post-install.yml || {
    log "Failed to download playbook"
    exit 1
}

# Create inventory file
cat > inventory.ini <<EOF
[proxmox_nodes]
$HOSTNAME ansible_connection=local

[proxmox_nodes:vars]
ansible_python_interpreter=/usr/bin/python3
EOF

# Run the playbook
log "Running Ansible playbook..."
ansible-playbook -i inventory.ini proxmox-post-install.yml \
    --extra-vars "provision_server=$PROVISION_SERVER" \
    2>&1 | tee -a "$LOG_FILE"

# Cleanup
cd /
rm -rf "$TEMP_DIR"

log "Ansible pull completed for $HOSTNAME"