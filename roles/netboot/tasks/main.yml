---
- name: Create temporary /etc/resolv.conf to allow for DNS lookups
  ansible.builtin.copy:
    dest: /etc/resolv.conf
    content: "nameserver 1.1.1.1"

- name: Disable systemd-resolved
  block:
    - name: Stop systemd-resolved
      service:
        name: systemd-resolved
        state: stopped
    - name: Disable systemd-resolved
      service:
        name: systemd-resolved
        enabled: no
    - name: Wait for systemd-resolved to fully stop
      wait_for:
        port: 53
        host: 127.0.0.1
        state: stopped
        timeout: 30
      ignore_errors: yes
    - name: Verify systemd-resolved is not running
      command: systemctl is-active systemd-resolved
      register: resolved_status
      failed_when: resolved_status.stdout == "active"
  rescue:
    - name: Log systemd-resolved disable failure
      debug:
        msg: "Failed to disable systemd-resolved cleanly, but continuing with dnsmasq setup"
  tags:
    - netboot

- name: Install dnsmasq and tftp server
  apt:
    name:
      - dnsmasq
      - tftpd-hpa
    state: present
  tags:
    - netboot

- name: Copy dnsmasq config
  template:
    src: provisioning.conf.j2
    dest: /etc/dnsmasq.d/provisioning.conf
  notify: restart dnsmasq
  tags:
    - netboot
    - dnsmasq_template

- name: Flush handlers to restart dnsmasq
  meta: flush_handlers


- name: Start and enable dnsmasq
  service:
    name: dnsmasq
    state: started
    enabled: yes
  tags:
    - netboot

- name: Wait for dnsmasq to bind to ports 53 and 69
  block:
    - name: Wait for dnsmasq DNS service to bind to port 53
      wait_for:
        port: 53
        host: "{{ dnsmasq_listen_address }}"
        state: started
        timeout: 30
    
    - name: Wait for dnsmasq TFTP service to bind to port 69
      wait_for:
        port: 69
        host: "{{ dnsmasq_listen_address }}"
        state: started
        timeout: 30
  tags:
    - netboot

- name: Remove /etc/resolv.conf symlink and configure DNS
  block:
    - name: Remove /etc/resolv.conf symlink
      file:
        path: /etc/resolv.conf
        state: absent
    
    - name: Create static /etc/resolv.conf
      template:
        src: resolv.conf.j2
        dest: /etc/resolv.conf
    
    - name: Verify DNS resolution works via dnsmasq
      command: nslookup google.com {{ dnsmasq_listen_address }}
      register: dns_test
      retries: 5
      delay: 2
      until: dns_test.rc == 0
      changed_when: false
  tags:
    - netboot

- name: Disable and stop all TFTP services to prevent conflicts with dnsmasq
  block:
    - name: Disable and stop tftpd-hpa
      service:
        name: tftpd-hpa
        state: stopped
        enabled: no
      ignore_errors: yes
    
    - name: Disable and stop xinetd (which may run in.tftpd)
      service:
        name: xinetd
        state: stopped
        enabled: no
      ignore_errors: yes
    
    - name: Check for and disable tftp.socket (systemd socket activation)
      service:
        name: tftp.socket
        state: stopped
        enabled: no
      ignore_errors: yes
    
    - name: Check for and disable tftp.service (systemd service)
      service:
        name: tftp.service
        state: stopped
        enabled: no
      ignore_errors: yes
      
    - name: Verify no TFTP services are listening on port 69
      wait_for:
        port: 69
        host: "{{ dnsmasq_listen_address }}"
        state: stopped
        timeout: 10
      ignore_errors: yes
  tags:
    - netboot

- name: Create tftpboot directory
  file:
    path: /var/lib/tftpboot
    state: directory
    owner: tftp
    group: tftp
    mode: "0755"
  tags:
    - netboot

- name: Check if iPXE bootloaders exist
  stat:
    path: "{{ item.dest }}"
  loop:
    - { url: "http://boot.ipxe.org/ipxe.efi", dest: "/var/lib/tftpboot/ipxe.efi" }
  register: ipxe_files
  tags:
    - netboot

- name: Download iPXE bootloaders
  get_url:
    url: "{{ item.item.url }}"
    dest: "{{ item.item.dest }}"
    mode: '0644'
  loop: "{{ ipxe_files.results }}"
  when: not item.stat.exists
  register: ipxe_download
  until: ipxe_download is succeeded
  retries: 5
  delay: 2
  tags:
    - netboot

- name: Test comprehensive DNS functionality
  block:
    - name: Test local domain resolution
      command: dig @{{ dnsmasq_listen_address }} {{ dnsmasq_domain }}
      register: local_dns_test
      changed_when: false
      failed_when: local_dns_test.rc != 0

    - name: Test external domain resolution
      command: dig @{{ dnsmasq_listen_address }} google.com
      register: external_dns_test
      changed_when: false
      failed_when: external_dns_test.rc != 0

    - name: Test static host resolution
      command: dig @{{ dnsmasq_listen_address }} gateway.{{ dnsmasq_domain }}
      register: static_dns_test
      changed_when: false
      failed_when: static_dns_test.rc != 0
      
    - name: Display DNS test results
      debug:
        msg: "All DNS functionality tests passed successfully"
  tags:
    - netboot
    - dns_test