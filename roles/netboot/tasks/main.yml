---
- name: Create temporary /etc/resolv.conf to allow for DNS lookups
  ansible.builtin.copy:
    dest: /etc/resolv.conf
    content: |
      nameserver 192.168.10.1
      nameserver 2606:4700:4700::1111
  tags:
    - foundation
    - dns_config

- name: Replace systemd-resolved with dnsmasq (Ubuntu 24.04 compatible)
  block:
    - name: Check if systemd-resolved is active
      systemd:
        name: systemd-resolved
      register: resolved_status
      ignore_errors: true
      
    - name: Stop and disable systemd-resolved socket (Ubuntu 24.04)
      systemd:
        name: systemd-resolved.socket
        state: stopped
        enabled: no
        masked: yes
      when: resolved_status.status is defined and resolved_status.status.ActiveState == 'active'
      ignore_errors: yes
      
    - name: Stop systemd-resolved service
      systemd:
        name: systemd-resolved
        state: stopped
      when: resolved_status.status is defined and resolved_status.status.ActiveState == 'active'
      ignore_errors: yes
      
    - name: Disable systemd-resolved service
      systemd:
        name: systemd-resolved
        enabled: no
      ignore_errors: yes
      
    - name: Mask systemd-resolved to prevent restart (Ubuntu 24.04)
      systemd:
        name: systemd-resolved
        masked: yes
      ignore_errors: yes
      
    - name: Prevent NetworkManager DNS management (Ubuntu 24.04)
      ini_file:
        path: /etc/NetworkManager/NetworkManager.conf
        section: main
        option: dns
        value: none
        create: yes
      ignore_errors: yes
      
    - name: Remove /etc/resolv.conf symlink
      file:
        path: /etc/resolv.conf
        state: absent
    
    - name: Create static /etc/resolv.conf
      copy:
        dest: /etc/resolv.conf
        content: |
          nameserver 192.168.10.1
          nameserver 2606:4700:4700::1111
  tags:
    - foundation
    - dns_config
    - services_install

- name: Create tftpboot directory for dnsmasq TFTP service (before dnsmasq installation)
  file:
    path: /var/lib/tftpboot
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags:
    - foundation
    - services_install

- name: Install dnsmasq and tftp client (dnsmasq provides TFTP server natively)
  apt:
    name:
      - dnsmasq
      - tftp-hpa
    state: present
  tags:
    - services_install
    - foundation
    - packages

- name: Remove conflicting TFTP server packages
  apt:
    name:
      - tftpd-hpa
      - atftpd
      - tftpd
    state: absent
  tags:
    - foundation
    - services_install

- name: Copy dnsmasq config
  template:
    src: provisioning.conf.j2
    dest: /etc/dnsmasq.d/provisioning.conf
  register: dnsmasq_config_deployed
  tags:
    - dns_config
    - services_install
    - maintenance

- name: Restart dnsmasq when configuration changes
  block:
    - name: Test dnsmasq configuration before restart
      command: dnsmasq --test --conf-file=/etc/dnsmasq.d/provisioning.conf
      changed_when: false
      register: dnsmasq_config_test
      
    - name: Restart dnsmasq service
      service:
        name: dnsmasq
        state: restarted
      when: dnsmasq_config_test.rc == 0
      register: dnsmasq_restart_result
      
    - name: Wait for dnsmasq DNS service to be ready
      wait_for:
        port: 53
        host: "{{ dnsmasq_listen_address | default('10.10.1.1') }}"
        state: started
        timeout: 15
      when: dnsmasq_restart_result.changed
      
  when: dnsmasq_config_deployed.changed
  tags:
    - dns_config
    - services_install
    - maintenance


- name: Start and enable dnsmasq with validation
  block:
    - name: Test dnsmasq configuration
      command: dnsmasq --test --conf-file=/etc/dnsmasq.d/provisioning.conf
      register: dnsmasq_test
      changed_when: false
      failed_when: false
      
    - name: Show dnsmasq configuration test results
      debug:
        msg: |
          Dnsmasq config test: {{ 'PASSED' if dnsmasq_test.rc == 0 else 'FAILED' }}
          {{ dnsmasq_test.stdout if dnsmasq_test.stdout else '' }}
          {{ dnsmasq_test.stderr if dnsmasq_test.stderr else '' }}
      
    - name: Check dnsmasq configuration syntax
      command: dnsmasq --test --conf-file=/etc/dnsmasq.d/provisioning.conf
      register: dnsmasq_syntax
      changed_when: false
      failed_when: dnsmasq_syntax.rc != 0
      
    - name: Verify provisioning bridge exists before starting dnsmasq
      command: ip link show {{ provisioning_bridge | default('br-prov') }}
      register: bridge_check
      changed_when: false
      failed_when: bridge_check.rc != 0
      
    - name: Start and enable dnsmasq
      systemd:
        name: dnsmasq
        state: restarted
        enabled: yes
  tags:
    - services_install
    - dns_config
    - validation

- name: Verify dnsmasq DNS service is running
  wait_for:
    port: 53
    host: "{{ dnsmasq_listen_address }}"
    state: started
    timeout: 15
  tags:
    - validation
    - dns_config

- name: Configure final DNS resolution
  block:
    - name: Remove /etc/resolv.conf symlink
      file:
        path: /etc/resolv.conf
        state: absent
    
    - name: Create static /etc/resolv.conf with dnsmasq
      template:
        src: resolv.conf.j2
        dest: /etc/resolv.conf
    
    - name: Verify IPv4 DNS resolution works via dnsmasq
      command: nslookup google.com {{ dnsmasq_listen_address }}
      register: dns_ipv4_test
      retries: 3
      delay: 2
      until: dns_ipv4_test.rc == 0
      changed_when: false
      
    - name: Verify IPv6 DNS resolution works via dnsmasq
      command: nslookup -type=AAAA google.com {{ dnsmasq_listen_address }}
      register: dns_ipv6_test
      retries: 3
      delay: 2
      until: dns_ipv6_test.rc == 0
      changed_when: false
      ignore_errors: yes  # IPv6 may not be fully configured yet
      
    - name: Test IPv6 DNS server availability
      command: dig @::1 google.com AAAA +short
      register: ipv6_dns_test
      changed_when: false
      ignore_errors: yes
      
    - name: Log DNS test results
      debug:
        msg:
          - "IPv4 DNS test: {{ 'PASSED' if dns_ipv4_test.rc == 0 else 'FAILED' }}"
          - "IPv6 DNS AAAA query: {{ 'PASSED' if dns_ipv6_test.rc == 0 else 'FAILED (may be expected)' }}"
          - "IPv6 DNS server test: {{ 'PASSED' if ipv6_dns_test.rc == 0 else 'FAILED (may be expected)' }}"
  tags:
    - dns_config
    - validation

- name: Ensure no conflicting TFTP services are running
  block:
    - name: Check which TFTP services exist before stopping them
      shell: "systemctl list-unit-files {{ item }} --no-pager --no-legend 2>/dev/null | grep -q . && echo 'exists' || echo 'not_found'"
      register: tftp_service_check
      loop:
        - tftpd-hpa
        - atftpd
        - xinetd
        - tftp.socket
        - tftp.service
      changed_when: false
      failed_when: false
    
    - name: Stop and disable existing conflicting TFTP services
      service:
        name: "{{ item.item }}"
        state: stopped
        enabled: no
      when: item.stdout == 'exists'
      loop: "{{ tftp_service_check.results }}"
      ignore_errors: yes
    
    - name: Verify no standalone TFTP services are listening on port 69
      shell: "netstat -ulnp | grep ':69 ' | grep -v dnsmasq || true"
      register: conflicting_tftp
      changed_when: false
      
    - name: Log conflicting TFTP services if found
      debug:
        msg: "Warning: Found non-dnsmasq services on port 69: {{ conflicting_tftp.stdout }}"
      when: conflicting_tftp.stdout != ""
  tags:
    - netboot

- name: Set proper ownership for tftpboot directory after dnsmasq installation
  file:
    path: /var/lib/tftpboot
    owner: dnsmasq
    group: nogroup
    mode: "0755"
    recurse: yes
  tags:
    - netboot

- name: Install Secure Boot PXE packages (SHIM + GRUB signed)
  apt:
    name:
      - shim-signed
      - grub-efi-amd64-signed
    state: present
  tags:
    - services_install
    - foundation
    - packages

- name: Create GRUB config directory in TFTP root
  file:
    path: /var/lib/tftpboot/grub
    state: directory
    owner: dnsmasq
    group: nogroup
    mode: "0755"
  tags:
    - netboot

- name: Deploy Microsoft-signed SHIM to TFTP
  copy:
    src: "{{ item }}"
    dest: /var/lib/tftpboot/shimx64.efi
    remote_src: yes
    owner: dnsmasq
    group: nogroup
    mode: '0644'
  with_first_found:
    - /usr/lib/shim/shimx64.efi.signed.latest
    - /usr/lib/shim/shimx64.efi.signed
  tags:
    - netboot
    - foundation

- name: Deploy Canonical-signed GRUB to TFTP
  copy:
    src: /usr/lib/grub/x86_64-efi-signed/grubnetx64.efi.signed
    dest: /var/lib/tftpboot/grubx64.efi
    remote_src: yes
    owner: dnsmasq
    group: nogroup
    mode: '0644'
  tags:
    - netboot
    - foundation

- name: Deploy GRUB PXE config (static MAC-mapped, Secure Boot compatible)
  copy:
    dest: /var/lib/tftpboot/grub.cfg
    owner: dnsmasq
    group: nogroup
    mode: '0644'
    content: |
      # PXE Provisioning - Secure Boot compatible (static MAC-mapped config)
      # GRUB's EFI network stack cannot reliably fetch dynamic configs on all firmware.
      # This static config maps MAC addresses to hostnames and boots rescue via HTTP.
      set timeout=5
      set default=0

      serial --unit=0 --speed=115200
      terminal_output console serial
      terminal_input console serial

      set rescue_hostname=unknown
      {% for host in dnsmasq_dhcp_reservations | selectattr('hostname', 'match', '^node') %}
      {% if loop.first %}
      if [ "$net_default_mac" = "{{ host.mac }}" ]; then
      {% else %}
      elif [ "$net_default_mac" = "{{ host.mac }}" ]; then
      {% endif %}
          set rescue_hostname={{ host.hostname }}
      {% endfor %}
      fi

      menuentry "Ubuntu Rescue ($rescue_hostname)" {
          echo "Booting rescue for $rescue_hostname (MAC: $net_default_mac)"
          echo "Loading kernel via HTTP..."
          linux (http,{{ provisioning_ip | default('10.10.1.1') }})/provisioning/ubuntu-rescue/vmlinuz boot=casper netboot=nfs nfsroot={{ provisioning_ip | default('10.10.1.1') }}:/srv/nfs/ubuntu-rescue ip=dhcp console=tty0 console=ttyS0,115200n8 rescue_hostname=$rescue_hostname rescue_server={{ provisioning_ip | default('10.10.1.1') }}
          echo "Loading initrd via HTTP..."
          initrd (http,{{ provisioning_ip | default('10.10.1.1') }})/provisioning/ubuntu-rescue/initrd
      }
  tags:
    - netboot
    - foundation

- name: Symlink grub.cfg to grub/ subdirectory
  file:
    src: /var/lib/tftpboot/grub.cfg
    dest: /var/lib/tftpboot/grub/grub.cfg
    state: link
    force: yes
  tags:
    - netboot
    - foundation

- name: Deploy iPXE bootstrap script (autoexec.ipxe)
  copy:
    dest: /var/lib/tftpboot/autoexec.ipxe
    owner: dnsmasq
    group: nogroup
    mode: '0644'
    content: |
      #!ipxe
      # SDDC Provisioning Bootstrap
      # iPXE fetches this after DHCP breakout (user-class detection)
      # Then chains to the PHP provisioning app for dynamic boot config
      dhcp
      chain http://{{ provisioning_ip | default('10.10.1.1') }}/?mac=${net0/mac}&format=ipxe || goto retry

      :retry
      echo Boot script fetch failed. Retrying in 5 seconds...
      sleep 5
      chain http://{{ provisioning_ip | default('10.10.1.1') }}/?mac=${net0/mac}&format=ipxe || goto shell

      :shell
      echo All boot attempts failed. Dropping to iPXE shell.
      shell
  tags:
    - netboot
    - foundation

- name: Force correct permissions on all TFTP files after download
  shell: |
    find /var/lib/tftpboot -type f -exec chown dnsmasq:nogroup {} \;
    find /var/lib/tftpboot -type f -exec chmod 644 {} \;
    ls -la /var/lib/tftpboot/
  register: tftp_perms_fix
  changed_when: false
  tags:
    - netboot

- name: Display TFTP file permissions
  debug:
    msg: "{{ tftp_perms_fix.stdout_lines }}"
  tags:
    - netboot

- name: Restart dnsmasq after fixing TFTP file permissions
  service:
    name: dnsmasq
    state: restarted
  tags:
    - netboot

- name: Wait for dnsmasq TFTP to restart
  pause:
    seconds: 3
  tags:
    - netboot

- name: Test comprehensive DNS functionality
  block:
    - name: Test local domain resolution
      command: dig @{{ dnsmasq_listen_address }} {{ dnsmasq_domain }}
      register: local_dns_test
      changed_when: false
      failed_when: local_dns_test.rc != 0

    - name: Test external domain resolution
      command: dig @{{ dnsmasq_listen_address }} google.com
      register: external_dns_test
      changed_when: false
      failed_when: external_dns_test.rc != 0

    - name: Test static host resolution
      command: dig @{{ dnsmasq_listen_address }} gateway.{{ dnsmasq_domain }}
      register: static_dns_test
      changed_when: false
      failed_when: static_dns_test.rc != 0
      
    - name: Display DNS test results
      debug:
        msg: "All DNS functionality tests passed successfully"
  tags:
    - validation
    - dns_config