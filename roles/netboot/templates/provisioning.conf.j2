# /etc/dnsmasq.d/provisioning.conf

# === General Configuration ===
# Bind to provisioning bridge interface
listen-address={{ provisioning_ip | default('10.10.1.1') }}
# IPv6 disabled for local services - only IPv4 for DNS/DHCP

# Interface binding - Bind to provisioning bridge
interface={{ provisioning_bridge | default('br-prov') }}
bind-interfaces
# Note: TFTP may bind to 0.0.0.0 even with interface binding
no-resolv
no-poll
clear-on-reload
no-negcache
domain={{ dnsmasq_domain }}
domain-needed
bogus-priv
dns-forward-max=1000

# IPv6 disabled for local DHCP/DNS services

# === Upstream DNS Servers (IPv4 and IPv6) ===
{% for server in dnsmasq_upstream_servers %}
server={{ server }}
{% endfor %}

# === Static DNS Records (A and PTR) ===
{% for host in dnsmasq_static_hosts %}
# A record for {{ host.name }}
host-record={{ host.name }},{{ host.ip }}
# PTR record for {{ host.name }}
ptr-record={{ host.ip | regex_replace('^(\d+\.\d+\.\d+\.)(\d+)$', '\2.\1') }}in-addr.arpa.,{{ host.name }}
{% endfor %}

# === DHCP Reservations and DNS Records (A and PTR) ===
{% for host in dnsmasq_dhcp_reservations %}
# DHCP reservation for {{ host.hostname }}
dhcp-host={{ host.mac }},{{ host.ip }},{{ host.hostname }}
# A record for the FQDN (e.g., "console-node1.sddc.info")
host-record={{ host.hostname }}.{{ dnsmasq_domain }},{{ host.ip }}
# A record for the short name (e.g., "console-node1")
host-record={{ host.hostname }},{{ host.ip }}
# PTR record for {{ host.hostname }}
ptr-record={{ host.ip | regex_replace('^(\d+\.\d+\.\d+\.)(\d+)$', '\2.\1') }}in-addr.arpa.,{{ host.hostname }}.{{ dnsmasq_domain }}
{% endfor %}

# === DHCP Configuration ===
# IPv4 DHCP
dhcp-range={{ dnsmasq_dhcp_range }}
dhcp-option=option:router,{{ dnsmasq_dhcp_router }}
dhcp-option=option:dns-server,{{ dnsmasq_dhcp_dns_server }}
# Proxmox Auto-Installer DHCP Option 250 (answer.toml URL)
dhcp-option=250,http://{{ provisioning_ip | default('10.10.1.1') }}/sessions/answer.toml

# IPv6 DHCP disabled - only IPv4 DHCP for local clients

dhcp-authoritative
log-dhcp


# === TFTP Configuration ===
enable-tftp
tftp-root={{ tftp_root }}
tftp-secure
tftp-lowercase

# === PXE/iPXE Chainloading Logic ===
dhcp-match=set:ipxe,175
dhcp-userclass=set:ipxe,iPXE
dhcp-match=set:efi-x86_64,option:client-arch,7
dhcp-match=set:efi-x86_64,option:client-arch,9
dhcp-boot=tag:!ipxe,tag:efi-x86_64,ipxe.efi
dhcp-boot=tag:ipxe,{{ ipxe_boot_url }}
