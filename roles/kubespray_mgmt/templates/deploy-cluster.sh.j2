#!/bin/bash
# Kubernetes cluster deployment script generated by Ansible
# Usage: ./deploy-cluster.sh [--check] [--tags TAG1,TAG2]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"
VENV_PATH="${SCRIPT_DIR}/venv"
INVENTORY_PATH="${SCRIPT_DIR}/inventory/{{ cluster_name }}/inventory.ini"

# Check if virtual environment exists
if [ ! -d "$VENV_PATH" ]; then
    echo "Error: Virtual environment not found at $VENV_PATH"
    echo "Please run the ansible provisioning playbook first."
    exit 1
fi

# Check if inventory exists
if [ ! -f "$INVENTORY_PATH" ]; then
    echo "Error: Inventory file not found at $INVENTORY_PATH"
    echo "Please run the ansible provisioning playbook first."
    exit 1
fi

# Activate virtual environment
echo "Activating virtual environment..."
export PATH="{{ ansible_env.HOME }}/.local/bin:$PATH:/usr/bin:/bin"
source "$VENV_PATH/bin/activate"

# Set working directory
cd "$SCRIPT_DIR"

# Parse arguments
ANSIBLE_ARGS=""
while [[ $# -gt 0 ]]; do
    case $1 in
        --check)
            ANSIBLE_ARGS="$ANSIBLE_ARGS --check"
            shift
            ;;
        --tags)
            ANSIBLE_ARGS="$ANSIBLE_ARGS --tags $2"
            shift 2
            ;;
        --skip-tags)
            ANSIBLE_ARGS="$ANSIBLE_ARGS --skip-tags $2"
            shift 2
            ;;
        -v|--verbose)
            ANSIBLE_ARGS="$ANSIBLE_ARGS -v"
            shift
            ;;
        -vv)
            ANSIBLE_ARGS="$ANSIBLE_ARGS -vv"
            shift
            ;;
        -vvv)
            ANSIBLE_ARGS="$ANSIBLE_ARGS -vvv"
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [--check] [--tags TAG1,TAG2] [--skip-tags TAG1,TAG2] [-v|-vv|-vvv]"
            exit 1
            ;;
    esac
done

# Test connectivity first
echo "Testing connectivity to all nodes..."
ansible all -i "$INVENTORY_PATH" -m ping

# Deploy the cluster
echo "Deploying Kubernetes cluster..."
echo "Command: ansible-playbook -i $INVENTORY_PATH --become --become-user=root cluster.yml $ANSIBLE_ARGS"

ansible-playbook -i "$INVENTORY_PATH" --become --become-user=root cluster.yml $ANSIBLE_ARGS

if [ $? -eq 0 ]; then
    echo ""
    echo "================================================================"
    echo "Kubernetes cluster deployment completed successfully!"
    echo "================================================================"
    echo ""
    echo "To access your cluster:"
    echo "1. Copy admin kubeconfig: mkdir -p ~/.kube && cp artifacts/admin.conf ~/.kube/config"
    echo "2. Install kubectl if not already available"
    echo "3. Test cluster: kubectl get nodes"
    echo ""
    echo "Cluster info:"
    echo "- Nodes: {{ kubernetes_nodes | length }}"
    echo "- Network plugin: {{ kube_network_plugin }}"
    echo "- Pod subnet: {{ kube_pods_subnet }}"
    echo "- Service subnet: {{ kube_service_addresses }}"
else
    echo ""
    echo "================================================================"
    echo "Deployment failed! Check the output above for errors."
    echo "================================================================"
    exit 1
fi